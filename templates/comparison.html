{% extends "base.html" %}
{% block title %}Comparison{% endblock %}
{% block content %}
<h2>SQL Comparison</h2>
<div class="editor-container">
    <div id="original-editor" class="editor"></div>
    <div id="corrected-editor" class="editor"></div>
</div>
<button onclick="validateSql()">Validate SQL</button>
<button onclick="saveSql()">Save All Corrections</button>
<div id="comparison-status" class="status-message"></div>
<div id="comparison-error" class="error-message"></div>
<script>
    let token = localStorage.getItem('token');
    // We need to know which client's config to use for validation.
    // A robust way would be to pass it in sessionStorage from the configurator,
    // but for now, we can assume the last active client is the one we need.
    // This part requires a client to have been selected on the configurator page.
    let currentClientId = sessionStorage.getItem('currentClientId'); 
    let originalEditor, correctedEditor;

    window.onload = () => {
        if (!token) {
            window.location.href = '/';
        }
        // A simple way to get the client ID is to fetch the list and use the first one
        // if one isn't already set. This makes the page work even if visited directly.
        if (!currentClientId) {
            fetch('/api/clients', { headers: { 'Authorization': `Bearer ${token}` } })
                .then(response => response.json())
                .then(clients => {
                    if (clients && clients.length > 0) {
                        currentClientId = clients[0].client_id;
                    }
                });
        }
    };

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' } });
    require(['vs/editor/editor.main'], function() {
        try {
            originalEditor = monaco.editor.create(document.getElementById('original-editor'), {
                value: sessionStorage.getItem('original_sql') || '-- No original SQL loaded --',
                language: 'sql',
                readOnly: true,
                theme: 'vs-dark',
                automaticLayout: true
            });
            correctedEditor = monaco.editor.create(document.getElementById('corrected-editor'), {
                value: sessionStorage.getItem('corrected_sql') || '-- No corrected SQL loaded --',
                language: 'sql',
                theme: 'vs-dark',
                automaticLayout: true
            });
        } catch (e) {
            document.getElementById('comparison-error').innerText = 'Failed to initialize editors: ' + e.message;
        }
    });

    function validateSql() {
        if (!currentClientId) {
            document.getElementById('comparison-error').innerText = 'Client context not found. Please go back to the configurator and select a client.';
            return;
        }
        const sqlToValidate = correctedEditor.getValue();
        fetch('/api/validate', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ sql: sqlToValidate, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('comparison-status').innerText = data.message;
            if (data.status === 'error') {
                document.getElementById('comparison-error').innerText = data.message;
            } else {
                document.getElementById('comparison-error').innerText = '';
            }
        })
        .catch(error => {
            document.getElementById('comparison-error').innerText = 'Error during validation: ' + error.message;
        });
    }

    function saveSql() {
        if (!currentClientId) {
            document.getElementById('comparison-error').innerText = 'Client context not found. Please go back to the configurator and select a client.';
            return;
        }
        const originalSql = originalEditor.getValue();
        const correctedSql = correctedEditor.getValue();
        fetch('/api/save', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ original_sql: originalSql, corrected_sql: correctedSql, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('comparison-error').innerText = data.error;
            } else {
                document.getElementById('comparison-status').innerText = data.message;
                document.getElementById('comparison-error').innerText = '';
            }
        })
        .catch(error => {
            document.getElementById('comparison-error').innerText = 'Error saving SQL: ' + error.message;
        });
    }
</script>
{% endblock %}
