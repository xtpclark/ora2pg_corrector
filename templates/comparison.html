{% extends "base.html" %}
{% block title %}Comparison{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">SQL Comparison</h2>
        <div class="card p-4">
            <div class="form-group mb-3">
                <label for="localFile" class="form-label">Local SQL File:</label>
                <div class="input-group">
                    <input type="text" id="localFile" class="form-control" name="localFile" placeholder="e.g., oracle_test_set.sql">
                    <button class="btn btn-primary" onclick="loadFile()">Load & Process Local File</button>
                </div>
            </div>
            <div class="editor-container mt-3">
                <div id="original-editor" class="editor"></div>
                <div id="corrected-editor" class="editor"></div>
            </div>
            <div class="mt-3">
                <button class="btn btn-primary" onclick="validateSql()">Validate SQL</button>
                <button class="btn btn-success" onclick="saveSql()">Save All Corrections</button>
            </div>
            <div id="comparison-status" class="status-message mt-3"></div>
            <div id="comparison-error" class="error-message mt-3"></div>
        </div>
    </div>
</div>
<script>
    let token = localStorage.getItem('token');
    let currentClientId = sessionStorage.getItem('currentClientId'); 
    let originalEditor, correctedEditor;

    window.onload = () => {
        if (!token) {
            window.location.href = '/';
        }
        if (!currentClientId) {
            fetch('/api/clients', { headers: { 'Authorization': `Bearer ${token}` } })
                .then(response => response.json())
                .then(clients => {
                    if (clients && clients.length > 0) {
                        currentClientId = clients[0].client_id;
                    }
                });
        }
    };

    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' } });
    require(['vs/editor/editor.main'], function() {
        try {
            originalEditor = monaco.editor.create(document.getElementById('original-editor'), {
                value: sessionStorage.getItem('original_sql') || '-- No original SQL loaded --',
                language: 'sql',
                readOnly: true,
                theme: 'vs-dark',
                automaticLayout: true
            });
            correctedEditor = monaco.editor.create(document.getElementById('corrected-editor'), {
                value: sessionStorage.getItem('corrected_sql') || '-- No corrected SQL loaded --',
                language: 'sql',
                theme: 'vs-dark',
                automaticLayout: true
            });
        } catch (e) {
            document.getElementById('comparison-error').innerText = 'Failed to initialize editors: ' + e.message;
        }
    });

    function validateSql() {
        if (!currentClientId) {
            document.getElementById('comparison-error').innerText = 'Client context not found. Please go back to the configurator and select a client.';
            return;
        }
        const sqlToValidate = correctedEditor.getValue();
        fetch('/api/validate', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ sql: sqlToValidate, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('comparison-status').innerText = data.message;
            if (data.status === 'error') {
                document.getElementById('comparison-error').innerText = data.message;
            } else {
                document.getElementById('comparison-error').innerText = '';
            }
        })
        .catch(error => {
            document.getElementById('comparison-error').innerText = 'Error during validation: ' + error.message;
        });
    }

    function saveSql() {
        if (!currentClientId) {
            document.getElementById('comparison-error').innerText = 'Client context not found. Please go back to the configurator and select a client.';
            return;
        }
        const originalSql = originalEditor.getValue();
        const correctedSql = correctedEditor.getValue();
        fetch('/api/save', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ original_sql: originalSql, corrected_sql: correctedSql, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('comparison-error').innerText = data.error;
            } else {
                document.getElementById('comparison-status').innerText = data.message;
                document.getElementById('comparison-error').innerText = '';
            }
        })
        .catch(error => {
            document.getElementById('comparison-error').innerText = 'Error saving SQL: ' + error.message;
        });
    }

    function loadFile() {
        if (!currentClientId) {
            document.getElementById('comparison-error').innerText = 'Client context not found. Please go back to the configurator and select a client.';
            return;
        }
        const filename = document.getElementById('localFile').value;
        fetch('/api/load_file', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('comparison-error').innerText = data.error;
            } else {
                sessionStorage.setItem('original_sql', data.original_sql);
                sessionStorage.setItem('corrected_sql', data.corrected_sql);
                originalEditor.setValue(data.original_sql || '-- No original SQL loaded --');
                correctedEditor.setValue(data.corrected_sql || '-- No corrected SQL loaded --');
                document.getElementById('comparison-status').innerText = 'File loaded and processed successfully';
                document.getElementById('comparison-error').innerText = '';
            }
        });
    }
</script>
{% endblock %}
