{% extends "base.html" %}
{% block title %}Configurator{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">Configurator</h2>
        <div class="card p-4">
            <div class="form-group mb-3">
                <label for="client_name" class="form-label">New Client Name:</label>
                <div class="input-group">
                    <input type="text" id="client_name" class="form-control" placeholder="Enter new client name">
                    <button class="btn btn-primary" onclick="createClient()">Create Client</button>
                </div>
            </div>
            <div id="client-list" class="mb-4"></div>
            <ul class="nav nav-tabs" id="configTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="ora2pg-tab" data-bs-toggle="tab" data-bs-target="#ora2pg" type="button" role="tab" aria-controls="ora2pg" aria-selected="true">Ora2Pg Configuration</button>
                </li>
            </ul>
            <div class="tab-content" id="configTabContent">
                <div class="tab-pane fade show active" id="ora2pg" role="tabpanel" aria-labelledby="ora2pg-tab">
                    <div id="ora2pg-config" class="mt-3"></div>
                    <button class="btn btn-success mt-3" onclick="saveOra2PgConfig()">Save Ora2Pg Configuration</button>
                </div>
            </div>
            <a href="/ai_config" class="btn btn-secondary mt-3">Configure AI Settings</a>
            <div id="status" class="status-message mt-3"></div>
            <div id="error" class="error-message mt-3"></div>
        </div>
    </div>
</div>
<script>
    let token = null;
    let currentClientId = null;

    function loadClients(authToken) {
        return fetch('/api/clients', { headers: { 'Authorization': `Bearer ${authToken}` } })
            .then(response => response.json())
            .then(clients => {
                const clientList = document.getElementById('client-list');
                clientList.innerHTML = '';
                clients.forEach(client => {
                    const div = document.createElement('div');
                    div.className = 'object-item';
                    div.innerText = client.client_name;
                    div.onclick = () => {
                        document.querySelectorAll('.object-item').forEach(item => item.classList.remove('active'));
                        div.classList.add('active');
                        currentClientId = client.client_id;
                        sessionStorage.setItem('currentClientId', currentClientId);
                        loadConfig(currentClientId, authToken);
                    };
                    clientList.appendChild(div);
                });
                return clients;
            });
    }

    function loadOra2pgConfigOptions(authToken) {
        return fetch('/api/ora2pg_config_options', { headers: { 'Authorization': `Bearer ${authToken}` } })
            .then(response => response.json())
            .then(options => {
                const configDiv = document.getElementById('ora2pg-config');
                configDiv.innerHTML = '';
                options.forEach(option => {
                    const div = document.createElement('div');
                    div.className = 'form-group';
                    const label = document.createElement('label');
                    label.innerText = option.description;
                    div.appendChild(label);
                    if (option.option_type === 'dropdown') {
                        const select = document.createElement('select');
                        select.className = 'form-select';
                        select.name = option.option_name.toLowerCase();
                        (option.allowed_values || '').split(',').forEach(value => {
                            if (value.trim()) {
                                const opt = document.createElement('option');
                                opt.value = value.trim();
                                opt.innerText = value.trim();
                                select.appendChild(opt);
                            }
                        });
                        select.value = option.default_value || '';
                        div.appendChild(select);
                    } else if (option.option_type === 'checkbox') {
                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.className = 'form-check-input';
                        input.name = option.option_name.toLowerCase();
                        input.checked = option.default_value === '1';
                        div.appendChild(input);
                    } else {
                        const input = document.createElement('input');
                        input.type = option.option_type === 'password' ? 'password' : 'text';
                        input.className = 'form-control';
                        input.name = option.option_name.toLowerCase();
                        input.value = option.default_value || '';
                        div.appendChild(input);
                    }
                    configDiv.appendChild(div);
                });
            });
    }

    function loadConfig(clientId, authToken) {
        fetch(`/api/client/${clientId}/config`, { headers: { 'Authorization': `Bearer ${authToken}` } })
            .then(response => response.json())
            .then(config => {
                const ora2pgConfig = document.getElementById('ora2pg-config');
                ora2pgConfig.querySelectorAll('input, select').forEach(input => {
                    if (input.type === 'checkbox') {
                        input.checked = config[input.name] || false;
                    } else {
                        input.value = config[input.name] || '';
                    }
                });
            });
    }

    function saveOra2PgConfig() {
        if (!currentClientId) { return; }
        const ora2pgConfig = document.getElementById('ora2pg-config');
        const config = {};
        ora2pgConfig.querySelectorAll('input, select').forEach(input => {
            config[input.name] = input.type === 'checkbox' ? input.checked : input.value;
        });
        fetch(`/api/client/${currentClientId}/config`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        }).then(response => {
            if (response.ok) document.getElementById('status').innerText = 'Ora2Pg Config saved successfully';
        });
    }

    function createClient() {
        const clientName = document.getElementById('client_name').value;
        if (!clientName) { return; }
        fetch('/api/clients', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ client_name: clientName })
        }).then(() => {
            document.getElementById('client_name').value = '';
            loadClients(token);
        });
    }

    window.onload = () => {
        token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/';
            return;
        }
        loadOra2pgConfigOptions(token);
        loadClients(token).then(clients => {
            if (clients && clients.length > 0) {
                document.querySelector('.object-item').click();
            }
        });
    };
</script>
{% endblock %}
