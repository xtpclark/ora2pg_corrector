{% extends "base.html" %}
{% block title %}Configurator{% endblock %}
{% block content %}
<h2>Configurator</h2>
<div class="form-group">
    <label for="client_name">New Client Name:</label>
    <input type="text" id="client_name" placeholder="Enter new client name">
    <button onclick="createClient()">Create Client</button>
</div>
<div id="client-list"></div>
<h3>Ora2Pg Configuration</h3>
<div id="ora2pg-config"></div>
<h3>AI Configuration</h3>
<div class="form-group">
    <label for="ai_provider">AI Provider:</label>
    <select id="ai_provider" name="ai_provider"></select>
</div>
<div class="form-group">
    <label for="ai_endpoint">AI Endpoint:</label>
    <input type="text" id="ai_endpoint" name="ai_endpoint">
</div>
<div class="form-group">
    <label for="ai_model">AI Model:</label>
    <input type="text" id="ai_model" name="ai_model">
</div>
<div class="form-group">
    <label for="ai_api_key">AI API Key:</label>
    <input type="password" id="ai_api_key" name="ai_api_key">
</div>
<div class="form-group">
    <label for="ai_temperature">AI Temperature:</label>
    <input type="number" id="ai_temperature" name="ai_temperature" step="0.1" value="0.7">
</div>
<div class="form-group">
    <label for="ai_max_output_tokens">AI Max Output Tokens:</label>
    <input type="number" id="ai_max_output_tokens" name="ai_max_output_tokens" value="4096">
</div>
<div class="form-group">
    <label for="ai_run_integrated">Run AI Integrated:</label>
    <input type="checkbox" id="ai_run_integrated" name="ai_run_integrated" checked>
</div>
<button onclick="saveConfig()">Save All Configurations</button>
<button onclick="exportConfig()">Export Config to ora2pg.conf</button>
<div class="form-group">
    <label for="localFile">Local SQL File:</label>
    <input type="text" id="localFile" name="localFile" placeholder="e.g., oracle_test_set.sql">
    <button onclick="loadFile()">Load & Process Local File</button>
</div>
<div id="status" class="status-message"></div>
<div id="error" class="error-message"></div>
<script>
    let token = localStorage.getItem('token');
    let currentClientId = null;

    function loadClients() {
        fetch('/api/clients', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(clients => {
            const clientList = document.getElementById('client-list');
            clientList.innerHTML = '';
            clients.forEach(client => {
                const div = document.createElement('div');
                div.className = 'object-item';
                div.innerText = client.client_name;
                div.onclick = () => {
                    currentClientId = client.client_id;
                    loadConfig(client.client_id);
                };
                clientList.appendChild(div);
            });
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error loading clients: ' + error.message;
        });
    }

    function createClient() {
        const clientName = document.getElementById('client_name').value;
        if (!clientName) {
            document.getElementById('error').innerText = 'Client name is required';
            return;
        }
        fetch('/api/clients', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ client_name: clientName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').innerText = data.error;
            } else {
                loadClients();
                document.getElementById('client_name').value = '';
                document.getElementById('error').innerText = '';
                document.getElementById('status').innerText = 'Client created successfully';
            }
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error creating client: ' + error.message;
        });
    }

    function loadAiProviders() {
        fetch('/api/ai_providers', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(providers => {
            const select = document.getElementById('ai_provider');
            select.innerHTML = '';
            providers.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.name;
                option.innerText = provider.name;
                select.appendChild(option);
            });
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error loading AI providers: ' + error.message;
        });
    }

    function loadOra2pgConfigOptions() {
        fetch('/api/ora2pg_config_options', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(options => {
            const configDiv = document.getElementById('ora2pg-config');
            configDiv.innerHTML = '';
            options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'form-group';
                const label = document.createElement('label');
                label.innerText = option.description;
                div.appendChild(label);
                if (option.option_type === 'dropdown') {
                    const select = document.createElement('select');
                    select.name = option.option_name.toLowerCase();
                    (option.allowed_values || '').split(',').forEach(value => {
                        if (value.trim()) {
                            const opt = document.createElement('option');
                            opt.value = value.trim();
                            opt.innerText = value.trim();
                            select.appendChild(opt);
                        }
                    });
                    select.value = option.default_value || '';
                    div.appendChild(select);
                } else if (option.option_type === 'checkbox') {
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = option.option_name.toLowerCase();
                    input.checked = option.default_value === '1';
                    div.appendChild(input);
                } else {
                    const input = document.createElement('input');
                    input.type = option.option_type === 'password' ? 'password' : 'text';
                    input.name = option.option_name.toLowerCase();
                    input.value = option.default_value || '';
                    div.appendChild(input);
                }
                configDiv.appendChild(div);
            });
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error loading Ora2Pg config options: ' + error.message;
        });
    }

    function loadConfig(clientId) {
        fetch(`/api/client/${clientId}/config`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(config => {
            document.getElementById('ai_provider').value = config.ai_provider || '';
            document.getElementById('ai_endpoint').value = config.ai_endpoint || '';
            document.getElementById('ai_model').value = config.ai_model || '';
            document.getElementById('ai_api_key').value = config.ai_api_key || '';
            document.getElementById('ai_temperature').value = config.ai_temperature || 0.7;
            document.getElementById('ai_max_output_tokens').value = config.ai_max_output_tokens || 4096;
            document.getElementById('ai_run_integrated').checked = config.ai_run_integrated || false;
            const ora2pgConfig = document.getElementById('ora2pg-config');
            ora2pgConfig.querySelectorAll('input, select').forEach(input => {
                if (input.type === 'checkbox') {
                    input.checked = config[input.name] || false;
                } else {
                    input.value = config[input.name] || '';
                }
            });
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error loading config: ' + error.message;
        });
    }

    function saveConfig() {
        if (!currentClientId) {
            document.getElementById('error').innerText = 'Please select a client first';
            return;
        }
        const config = {
            ai_provider: document.getElementById('ai_provider').value,
            ai_endpoint: document.getElementById('ai_endpoint').value,
            ai_model: document.getElementById('ai_model').value,
            ai_api_key: document.getElementById('ai_api_key').value,
            ai_temperature: document.getElementById('ai_temperature').value,
            ai_max_output_tokens: document.getElementById('ai_max_output_tokens').value,
            ai_run_integrated: document.getElementById('ai_run_integrated').checked
        };
        const ora2pgConfig = document.getElementById('ora2pg-config');
        ora2pgConfig.querySelectorAll('input, select').forEach(input => {
            config[input.name] = input.type === 'checkbox' ? input.checked : input.value;
        });
        fetch(`/api/client/${currentClientId}/config`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').innerText = data.error;
            } else {
                document.getElementById('status').innerText = data.message || 'Configuration saved';
                document.getElementById('error').innerText = '';
            }
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error saving config: ' + error.message;
        });
    }

    function exportConfig() {
        if (!currentClientId) {
            document.getElementById('error').innerText = 'Please select a client first';
            return;
        }
        fetch(`/api/client/${currentClientId}/export_config`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').innerText = data.error;
                return;
            }
            const blob = new Blob([data.config_content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ora2pg.conf';
            a.click();
            window.URL.revokeObjectURL(url);
            document.getElementById('status').innerText = 'Configuration exported';
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error exporting config: ' + error.message;
        });
    }

    function loadFile() {
        if (!currentClientId) {
            document.getElementById('error').innerText = 'Please select a client first';
            return;
        }
        const filename = document.getElementById('localFile').value;
        if (!filename) {
            document.getElementById('error').innerText = 'Please enter a filename';
            return;
        }
        fetch('/api/load_file', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').innerText = data.error;
            } else {
                document.getElementById('status').innerText = data.logs;
                document.getElementById('error').innerText = '';
                window.location.href = '/comparison?original=' + encodeURIComponent(data.original_sql) + '&corrected=' + encodeURIComponent(data.corrected_sql);
            }
        })
        .catch(error => {
            document.getElementById('error').innerText = 'Error loading file: ' + error.message;
        });
    }

    window.onload = () => {
        if (!token) {
            window.location.href = '/';
        } else {
            loadClients();
            loadAiProviders();
            loadOra2pgConfigOptions();
        }
    };
</script>
{% endblock %}
