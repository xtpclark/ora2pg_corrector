<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ora2Pg AI Corrector - Configurator</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js"></script>
</head>
<body>
    <div class="container">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Configurator</a>
                <div class="navbar-nav">
                    <a class="nav-link" href="/comparison">Comparison</a>
                    <a class="nav-link" href="/logout" onclick="localStorage.removeItem('token');">Logout</a>
                </div>
            </div>
        </nav>
        <div class="content-wrapper">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">Configurator <span id="version-display" class="fs-6 fw-light ms-2"></span></h2>
                    <div class="card p-4">
                        <div class="form-group mb-3">
                            <label for="client_name" class="form-label">New Client Name:</label>
                            <div class="input-group">
                                <input type="text" id="client_name" class="form-control" placeholder="Enter new client name">
                                <button class="btn btn-primary" onclick="createClient()">Create Client</button>
                            </div>
                        </div>
                        <div id="client-list" class="mb-4"></div>
                        <ul class="nav nav-tabs" id="configTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai" type="button" role="tab" aria-controls="ai" aria-selected="true">AI Config</button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="ora2pg-tab" data-bs-toggle="tab" data-bs-target="#ora2pg" type="button" role="tab" aria-controls="ora2pg" aria-selected="false">Ora2PG Config</button>
                            </li>
                        </ul>
                        <div class="tab-content" id="configTabContent">
                            <div class="tab-pane fade show active" id="ai" role="tabpanel" aria-labelledby="ai-tab">
                                <div class="form-group mb-3">
                                    <label for="ai_provider" class="form-label">AI Provider:</label>
                                    <select id="ai_provider" class="form-select" name="ai_provider" onchange="updateProviderDetails()"></select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="ai_endpoint" class="form-label">AI Endpoint:</label>
                                    <input type="text" id="ai_endpoint" class="form-control" name="ai_endpoint">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="ai_model" class="form-label">AI Model:</label>
                                    <input type="text" id="ai_model" class="form-control" name="ai_model">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="ai_api_key" class="form-label">AI API Key:</label>
                                    <input type="password" id="ai_api_key" class="form-control" name="ai_api_key">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="ai_temperature" class="form-label">AI Temperature:</label>
                                    <input type="number" id="ai_temperature" class="form-control" name="ai_temperature" step="0.1" value="0.2">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="ai_max_output_tokens" class="form-label">AI Max Output Tokens:</label>
                                    <input type="number" id="ai_max_output_tokens" class="form-control" name="ai_max_output_tokens" value="8192">
                                </div>
                                <div class="form-group mb-3">
                                    <label for="ai_run_integrated" class="form-label">Run AI Integrated:</label>
                                    <input type="checkbox" id="ai_run_integrated" class="form-check-input" name="ai_run_integrated" checked>
                                </div>
                                <button class="btn btn-success mt-3" onclick="saveConfig('ai')">Save AI Configuration</button>
                            </div>
                            <div class="tab-pane fade" id="ora2pg" role="tabpanel" aria-labelledby="ora2pg-tab">
                                <div id="ora2pg-config" class="mt-3"></div>
                                <button class="btn btn-success mt-3" onclick="saveConfig('ora2pg')">Save Ora2PG Configuration</button>
                            </div>
                        </div>
                        <div id="status" class="status-message mt-3"></div>
                        <div id="error" class="error-message mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const version = "v1.2"; // Version number to display
        let token = null;
        let currentClientId = null;
        let providers = [];
        let ora2pgOptions = null;
        let currentConfig = null; // Variable to store the loaded configuration

        // Helper function to handle fetch API errors more robustly
        function handleFetchError(response) {
            if (!response.ok) {
                return response.text().then(text => {
                    try {
                        const errorJson = JSON.parse(text);
                        throw new Error(errorJson.error || `HTTP error! status: ${response.status}`);
                    } catch (e) {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${text}`);
                    }
                });
            }
            return response.json().catch(error => {
                console.error("JSON parse error:", error);
                throw new Error("Failed to parse server response.");
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('version-display').innerText = version; // Display the version
            token = localStorage.getItem('token');
            if (!token) {
                document.body.innerHTML = '<div class="container p-5"><div class="alert alert-danger">Authentication token not found. Please log in.</div></div>';
                return;
            }

            // Chain all initial loading calls and add a final .catch for error handling
            loadOra2pgConfigOptions(token)
                .then(() => loadAiProviders(token))
                .then(() => loadClients(token))
                .then(clients => {
                    if (clients && clients.length > 0) {
                        const firstClient = document.querySelector('.object-item');
                        if (firstClient) {
                            firstClient.click();
                        }
                    }
                })
                .catch(error => {
                    console.error("Initialization failed:", error);
                    document.getElementById('error').innerText = 'Failed to initialize the configurator. Please check the console for details.';
                });

            // FIX: Manually handle tab clicks to ensure they activate.
            // This can resolve issues where Bootstrap's data-api fails to initialize.
            document.querySelectorAll('#configTabs button[data-bs-toggle="tab"]').forEach(tabEl => {
                tabEl.addEventListener('click', function (event) {
                    event.preventDefault();
                    const tab = new bootstrap.Tab(this);
                    tab.show();
                });
            });

            // Tab switch listener now uses stored config data instead of fetching again
            $('#configTabs button').on('shown.bs.tab', function (e) {
                const tabId = e.target.getAttribute('id');
                if (tabId === 'ora2pg-tab' && currentClientId && ora2pgOptions && currentConfig) {
                    renderOra2pgConfig(ora2pgOptions, currentConfig);
                }
            });
        });

        function loadAiProviders(authToken) {
            return fetch('/api/ai_providers', { headers: { 'Authorization': `Bearer ${authToken}` } })
                .then(handleFetchError)
                .then(data => {
                    providers = data;
                    const select = document.getElementById('ai_provider');
                    select.innerHTML = '<option value="">Select a provider</option>';
                    providers.forEach(provider => {
                        const option = document.createElement('option');
                        option.value = provider.name;
                        option.innerText = provider.name;
                        select.appendChild(option);
                    });
                });
        }

        function loadClients(authToken) {
            return fetch('/api/clients', { headers: { 'Authorization': `Bearer ${authToken}` } })
                .then(handleFetchError)
                .then(clients => {
                    const clientList = document.getElementById('client-list');
                    clientList.innerHTML = '';
                    clients.forEach(client => {
                        const div = document.createElement('div');
                        div.className = 'object-item';
                        div.innerText = client.client_name;
                        div.onclick = () => {
                            document.querySelectorAll('.object-item').forEach(item => item.classList.remove('active'));
                            div.classList.add('active');
                            currentClientId = client.client_id;
                            sessionStorage.setItem('currentClientId', currentClientId);
                            
                            currentConfig = null;
                            document.getElementById('ora2pg-config').innerHTML = '';
                            document.getElementById('status').innerText = '';
                            document.getElementById('error').innerText = '';
                            
                            loadConfig(currentClientId, token);
                        };
                        clientList.appendChild(div);
                    });
                    return clients;
                });
        }

        function loadOra2pgConfigOptions(authToken) {
            if (ora2pgOptions) return Promise.resolve(ora2pgOptions);
            return fetch('/api/ora2pg_config_options', { headers: { 'Authorization': `Bearer ${authToken}` } })
                .then(handleFetchError)
                .then(options => {
                    ora2pgOptions = options;
                    return options;
                });
        }

        function renderOra2pgConfig(options, config) {
            const configDiv = document.getElementById('ora2pg-config');
            configDiv.innerHTML = '';
            options.forEach(option => {
                const div = document.createElement('div');
                div.className = 'form-group mb-3';
                const label = document.createElement('label');
                label.className = 'form-label';
                label.innerText = option.description;
                div.appendChild(label);

                if (option.option_type === 'dropdown') {
                    const select = document.createElement('select');
                    select.className = 'form-select';
                    select.name = option.option_name.toLowerCase();
                    (option.allowed_values || '').split(',').forEach(value => {
                        if (value.trim()) {
                            const opt = document.createElement('option');
                            opt.value = value.trim();
                            opt.innerText = value.trim();
                            select.appendChild(opt);
                        }
                    });
                    select.value = config[option.option_name.toLowerCase()] || option.default_value || '';
                    div.appendChild(select);
                } else if (option.option_type === 'checkbox') {
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'form-check-input';
                    input.name = option.option_name.toLowerCase();
                    input.checked = config[option.option_name.toLowerCase()] || option.default_value === '1';
                    div.appendChild(input);
                } else {
                    const input = document.createElement('input');
                    input.type = option.option_type === 'password' ? 'password' : 'text';
                    input.className = 'form-control';
                    input.name = option.option_name.toLowerCase();
                    input.value = config[option.option_name.toLowerCase()] || option.default_value || '';
                    div.appendChild(input);
                }
                configDiv.appendChild(div);
            });
        }

        function loadConfig(clientId, authToken) {
            fetch(`/api/client/${clientId}/config`, { headers: { 'Authorization': `Bearer ${authToken}` } })
                .then(handleFetchError)
                .then(config => {
                    currentConfig = config; 

                    document.getElementById('ai_provider').value = config.ai_provider || '';
                    updateProviderDetails();
                    if (config.ai_endpoint) document.getElementById('ai_endpoint').value = config.ai_endpoint;
                    if (config.ai_model) document.getElementById('ai_model').value = config.ai_model;
                    document.getElementById('ai_api_key').value = config.ai_api_key || '';
                    document.getElementById('ai_temperature').value = config.ai_temperature || 0.2;
                    document.getElementById('ai_max_output_tokens').value = config.ai_max_output_tokens || 8192;
                    document.getElementById('ai_run_integrated').checked = config.ai_run_integrated || false;
                    
                    if (ora2pgOptions && document.querySelector('#ora2pg-tab').classList.contains('active')) {
                        renderOra2pgConfig(ora2pgOptions, currentConfig);
                    }
                })
                .catch(error => {
                    console.error("Error loading configuration:", error);
                    document.getElementById('error').innerText = 'Failed to load client configuration.';
                });
        }

        function updateProviderDetails() {
            const select = document.getElementById('ai_provider');
            const selectedProviderName = select.value;
            const provider = providers.find(p => p.name === selectedProviderName);
            if (provider) {
                document.getElementById('ai_endpoint').value = provider.api_endpoint;
                document.getElementById('ai_model').value = provider.default_model;
            } else {
                document.getElementById('ai_endpoint').value = '';
                document.getElementById('ai_model').value = '';
            }
        }

        function saveConfig(configType) {
            if (!currentClientId) { 
                document.getElementById('error').innerText = 'Please select a client first.';
                return; 
            }
            const configData = {};
            document.getElementById('status').innerText = '';
            document.getElementById('error').innerText = '';

            if (configType === 'ora2pg') {
                const ora2pgConfig = document.getElementById('ora2pg-config');
                ora2pgConfig.querySelectorAll('input, select').forEach(input => {
                    configData[input.name] = input.type === 'checkbox' ? input.checked : input.value;
                });
            } else if (configType === 'ai') {
                configData.ai_provider = document.getElementById('ai_provider').value;
                configData.ai_endpoint = document.getElementById('ai_endpoint').value;
                configData.ai_model = document.getElementById('ai_model').value;
                configData.ai_api_key = document.getElementById('ai_api_key').value;
                configData.ai_temperature = document.getElementById('ai_temperature').value;
                configData.ai_max_output_tokens = document.getElementById('ai_max_output_tokens').value;
                configData.ai_run_integrated = document.getElementById('ai_run_integrated').checked;
            }

            fetch(`/api/client/${currentClientId}/config`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(configData)
            }).then(response => {
                if (response.ok) {
                    document.getElementById('status').innerText = `${configType.toUpperCase()} Config saved successfully`;
                    if (currentConfig) {
                        Object.assign(currentConfig, configData);
                    }
                } else {
                    document.getElementById('error').innerText = 'Save failed. Check console for details.';
                }
            }).catch(err => {
                document.getElementById('error').innerText = 'An error occurred during save.';
                console.error('Save error:', err);
            });
        }

        function createClient() {
            const clientName = document.getElementById('client_name').value;
            if (!clientName) { 
                document.getElementById('error').innerText = 'Client name cannot be empty.';
                return;
            }
            document.getElementById('error').innerText = '';
            
            fetch('/api/clients', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ client_name: clientName })
            })
            .then(handleFetchError)
            .then(() => {
                document.getElementById('client_name').value = '';
                loadClients(token);
            })
            .catch(error => {
                console.error("Error creating client:", error);
                document.getElementById('error').innerText = 'Failed to create new client.';
            });
        }
    </script>
</body>
</html>

