{% extends "base.html" %}
{% block title %}Configurator{% endblock %}
{% block content %}
<h2>Configurator</h2>
<div class="form-group">
    <label for="client_name">New Client Name:</label>
    <input type="text" id="client_name" placeholder="Enter new client name">
    <button onclick="createClient()">Create Client</button>
</div>
<div id="client-list"></div>
<h3>Ora2Pg Configuration</h3>
<div id="ora2pg-config"></div>
<h3>AI Configuration</h3>
<div class="form-group">
    <label for="ai_provider">AI Provider:</label>
    <select id="ai_provider" name="ai_provider" onchange="updateProviderDetails()"></select>
</div>
<div class="form-group">
    <label for="ai_endpoint">AI Endpoint:</label>
    <input type="text" id="ai_endpoint" name="ai_endpoint">
</div>
<div class="form-group">
    <label for="ai_model">AI Model:</label>
    <input type="text" id="ai_model" name="ai_model">
</div>
<div class="form-group">
    <label for="ai_api_key">AI API Key:</label>
    <input type="password" id="ai_api_key" name="ai_api_key">
</div>
<div class="form-group">
    <label for="ai_temperature">AI Temperature:</label>
    <input type="number" id="ai_temperature" name="ai_temperature" step="0.1" value="0.2">
</div>
<div class="form-group">
    <label for="ai_max_output_tokens">AI Max Output Tokens:</label>
    <input type="number" id="ai_max_output_tokens" name="ai_max_output_tokens" value="8192">
</div>
<div class="form-group">
    <label for="ai_run_integrated">Run AI Integrated:</label>
    <input type="checkbox" id="ai_run_integrated" name="ai_run_integrated" checked>
</div>
<button onclick="saveConfig()">Save All Configurations</button>
<button onclick="exportConfig()">Export Config to ora2pg.conf</button>
<div class="form-group">
    <label for="localFile">Local SQL File:</label>
    <input type="text" id="localFile" name="localFile" placeholder="e.g., oracle_test_set.sql">
    <button onclick="loadFile()">Load & Process Local File</button>
</div>
<div id="status" class="status-message"></div>
<div id="error" class="error-message"></div>
<script>
    let token = localStorage.getItem('token');
    let currentClientId = null;
    let providers = [];

    function loadAiProviders() {
        return fetch('/api/ai_providers', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(response => response.json())
            .then(data => {
                providers = data;
                const select = document.getElementById('ai_provider');
                select.innerHTML = '<option value="">Select a provider</option>';
                providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.name;
                    option.innerText = provider.name;
                    select.appendChild(option);
                });
            });
    }

    function loadClients() {
        return fetch('/api/clients', { headers: { 'Authorization': `Bearer ${token}` } })
            .then(response => response.json())
            .then(clients => {
                const clientList = document.getElementById('client-list');
                clientList.innerHTML = '';
                clients.forEach(client => {
                    const div = document.createElement('div');
                    div.className = 'object-item';
                    div.innerText = client.client_name;
                    div.onclick = () => {
                        document.querySelectorAll('.object-item').forEach(item => item.classList.remove('active'));
                        div.classList.add('active');
                        currentClientId = client.client_id;
                        loadConfig(client.client_id);
                    };
                    clientList.appendChild(div);
                });
                return clients;
            });
    }
    
    function loadOra2pgConfigOptions() { /* Function content is correct, omitted for brevity */ }
    function updateProviderDetails() { /* Function content is correct, omitted for brevity */ }
    function loadConfig(clientId) { /* Function content is correct, omitted for brevity */ }
    function saveConfig() { /* Function content is correct, omitted for brevity */ }
    function exportConfig() { /* Function content is correct, omitted for brevity */ }
    function createClient() { /* Function content is correct, omitted for brevity */ }

    function loadFile() {
        if (!currentClientId) {
            document.getElementById('error').innerText = 'Please select a client first';
            return;
        }
        const filename = document.getElementById('localFile').value;
        if (!filename) { return; }
        fetch('/api/load_file', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename, client_id: currentClientId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                document.getElementById('error').innerText = data.error;
            } else {
                sessionStorage.setItem('original_sql', data.original_sql);
                sessionStorage.setItem('corrected_sql', data.corrected_sql);
                window.location.href = '/comparison';
            }
        });
    }

    window.onload = () => {
        if (!token) {
            window.location.href = '/';
        } else {
            loadOra2pgConfigOptions();
            loadAiProviders().then(() => {
                loadClients().then(clients => {
                    if (clients && clients.length > 0) {
                        document.querySelector('.object-item').click();
                    }
                });
            });
        }
    };
</script>
{% endblock %}
