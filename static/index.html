<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ora2PG AI Corrector</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); overflow: hidden; }
        #root { padding: 24px; }
        .login-form { max-width: 400px; margin: 40px auto; padding: 20px; }
        .tabs { display: flex; border-bottom: 1px solid #d9d9d9; margin-bottom: 24px; }
        .tab { padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; color: #555; font-weight: 500; }
        .tab.active { border-bottom-color: #007bff; color: #007bff; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: #007bff; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .ai-help-text { font-size: 12px; color: #555; margin-top: 8px; background-color: #f8f9fa; padding: 10px; border-radius: 4px; border: 1px solid #e9ecef; }
        .ai-help-text a { color: #007bff; text-decoration: none; }
        .ai-help-text a:hover { text-decoration: underline; }
        button { padding: 10px 18px; margin: 5px; background-color: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #a0cffa; cursor: not-allowed; }
        button.secondary { background-color: #6c757d; }
        h2, h3 { border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 16px; color: #333; }
        .error { color: #dc3545; font-weight: 500; }
        .status-message { color: #28a745; font-weight: 500; margin-left: 10px; }
        .object-list { max-height: 400px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 6px; background: #fff; margin-bottom: 16px; }
        .object-item { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .object-item:hover { background: #f0f2f5; }
        .diff-view { display: flex; gap: 16px; margin-top: 16px; }
        .diff-view > div { flex: 1; border: 1px solid #dee2e6; border-radius: 6px; overflow: hidden; }
        #editor, #corrected-editor { height: 500px; }
    </style>
</head>
<body>
    <div class="container"><div id="root"></div></div>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.28.4/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs/loader.js"></script>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [token, setToken] = useState(localStorage.getItem('authToken'));
            
            const handleLoginSuccess = (newToken) => {
                localStorage.setItem('authToken', newToken);
                setToken(newToken);
            };

            if (!token) {
                return <LoginScreen onLoginSuccess={handleLoginSuccess} />;
            }
            return <ClientManager token={token} />;
        }
        
        function LoginScreen({ onLoginSuccess }) {
            const [username, setUsername] = useState('admin');
            const [password, setPassword] = useState('password');
            const [error, setError] = useState('');
            const handleLogin = async () => {
                try {
                    const response = await axios.post('/api/login', { username, password });
                    onLoginSuccess(response.data.token);
                } catch (err) {
                    setError('Invalid credentials');
                }
            };
            return (<div className="login-form"><h2>Login</h2><div className="form-group"><label>Username</label><input value={username} onChange={e => setUsername(e.target.value)} /></div><div className="form-group"><label>Password</label><input type="password" value={password} onChange={e => setPassword(e.target.value)} /></div>{error && <p className="error">{error}</p>}<button onClick={handleLogin}>Login</button></div>);
        }

        function ClientManager({ token }) {
            const [clients, setClients] = useState([]);
            const [selectedClient, setSelectedClient] = useState(null);
            const [newClientName, setNewClientName] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                axios.get('/api/clients', { headers: { Authorization: `Bearer ${token}` } })
                    .then(res => setClients(res.data))
                    .catch(err => setError('Failed to load clients.'));
            }, [token]);

            const createClient = async () => {
                if (!newClientName.trim()) return;
                try {
                    const response = await axios.post('/api/clients', { client_name: newClientName }, { headers: { Authorization: `Bearer ${token}` } });
                    setClients(prev => [...prev, response.data]);
                    setNewClientName('');
                    setError('');
                } catch(err) {
                    setError(err.response?.data?.error || 'Failed to create client.');
                }
            };
            
            if (selectedClient) return <ClientDetailView client={selectedClient} token={token} onBack={() => setSelectedClient(null)} />;
            
            return (<div><h2>Client Manager</h2><div className="form-group" style={{ display: 'flex', gap: '10px', alignItems: 'center' }}><input value={newClientName} onChange={e => setNewClientName(e.target.value)} placeholder="New client name" style={{flex: 1}} /><button onClick={createClient}>Create Client</button></div>{error && <p className="error">{error}</p>}<h3>Existing Clients</h3><div className="object-list">{clients.map(c => <div key={c.client_id} className="object-item" onClick={() => setSelectedClient(c)}>{c.client_name}</div>)}</div></div>);
        }

        function ClientDetailView({ client, token, onBack }) {
            const [activeTab, setActiveTab] = useState('configurator');
            const [processedSql, setProcessedSql] = useState(null);

            const handleProcessingComplete = (sqlContent) => {
                setProcessedSql(sqlContent);
                setActiveTab('comparison');
            };

            return (
                <div>
                    <button onClick={onBack} className="secondary">‚Üê Back to Clients</button>
                    <h2>Client: {client.client_name}</h2>
                    <div className="tabs">
                        <div className={`tab ${activeTab === 'configurator' ? 'active' : ''}`} onClick={() => setActiveTab('configurator')}>Configurator</div>
                        <div className={`tab ${activeTab === 'comparison' ? 'active' : ''}`} onClick={() => setActiveTab('comparison')}>Comparison</div>
                    </div>
                    {activeTab === 'configurator' && <Configurator client={client} token={token} onProcessingComplete={handleProcessingComplete} />}
                    {activeTab === 'comparison' && <ComparisonView client={client} token={token} initialSql={processedSql} />}
                </div>
            );
        }

        function Configurator({ client, token, onProcessingComplete }) {
            const [config, setConfig] = useState({});
            const [aiProviders, setAiProviders] = useState([]);
            const [status, setStatus] = useState('');
            const [error, setError] = useState('');
            const [logs, setLogs] = useState('');
            const [localFile, setLocalFile] = useState('oracle_test_set.sql');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                axios.get('/api/ai_providers', { headers: { Authorization: `Bearer ${token}` } })
                    .then(res => setAiProviders(res.data))
                    .catch(err => setError('Failed to load AI providers.'));
                
                axios.get(`/api/client/${client.client_id}/config`, { headers: { Authorization: `Bearer ${token}` } })
                    .then(res => setConfig(res.data))
                    .catch(err => setError('Failed to load client configuration.'));
            }, [client.client_id, token]);

            const handleProviderChange = e => {
                const providerName = e.target.value;
                const provider = aiProviders.find(p => p.name === providerName);
                if (provider) {
                    setConfig(prev => ({ ...prev, ai_provider: provider.name, ai_endpoint: provider.api_endpoint, ai_model: provider.default_model, }));
                } else {
                    setConfig(prev => ({ ...prev, ai_provider: providerName }));
                }
            };

            const handleChange = e => {
                const { name, value, type, checked } = e.target;
                setConfig(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value }));
            };
            
            const saveConfig = async () => {
                setStatus('Saving...'); setError('');
                try {
                    await axios.post(`/api/client/${client.client_id}/config`, config, { headers: { Authorization: `Bearer ${token}` } });
                    setStatus('Configuration saved!');
                } catch (err) { setError('Failed to save config.'); }
                finally { setTimeout(() => setStatus(''), 3000); }
            };

            const runAction = async (actionType) => {
                await saveConfig();
                setLoading(true); setStatus(`Running ${actionType}...`); setLogs(''); setError('');
                
                const payload = actionType === 'run_ora2pg' 
                    ? { ...config, client_id: client.client_id } 
                    : { filename: localFile, client_id: client.client_id };
                const url = actionType === 'run_ora2pg' ? '/api/run' : '/api/load_file';

                try {
                    const response = await axios.post(url, payload, { headers: { Authorization: `Bearer ${token}` } });
                    setLogs(response.data.logs);
                    setStatus(`${actionType === 'run_ora2pg' ? 'Ora2Pg' : 'File load'} complete.`);
                    if(response.data.output_sql) {
                        onProcessingComplete(response.data.output_sql);
                    }
                } catch (err) {
                    const errorMsg = err.response?.data?.error || err.response?.data?.logs || 'An error occurred.';
                    setError(`Failed to ${actionType}.`);
                    setLogs(errorMsg);
                } finally {
                    setLoading(false);
                }
            };

            const selectedProvider = aiProviders.find(p => p.name === config.ai_provider);

            return (
                <div>
                    <h3>Ora2Pg Configuration</h3>
                     <div className="form-grid">
                        <div className="form-group"><label>Oracle DSN</label><input name="oracle_dsn" value={config.oracle_dsn || ''} onChange={handleChange} /></div>
                        <div className="form-group"><label>Oracle User</label><input name="oracle_user" value={config.oracle_user || ''} onChange={handleChange} /></div>
                        <div className="form-group"><label>Oracle Password</label><input type="password" name="oracle_password" value={config.oracle_password || ''} onChange={handleChange} /></div>
                        <div className="form-group"><label>Migration Type</label><select name="type" value={config.type || 'SHOW_REPORT'} onChange={handleChange}><option value="SHOW_REPORT">SHOW_REPORT</option><option value="FUNCTION">FUNCTION</option><option value="PROCEDURE">PROCEDURE</option></select></div>
                    </div>

                    <h3>AI Configuration</h3>
                    <div className="form-grid">
                        <div className="form-group"><label>AI Provider</label><select name="ai_provider" value={config.ai_provider || ''} onChange={handleProviderChange}><option value="" disabled>-- Select a Provider --</option>{aiProviders.map(p => <option key={p.provider_id} value={p.name}>{p.name}</option>)}<option value="Custom">Custom</option></select>
                            {selectedProvider && (<div className="ai-help-text"><a href={selectedProvider.key_url} target="_blank" rel="noopener noreferrer">Get your API key here.</a><p style={{margin: '8px 0 0 0'}}>{selectedProvider.notes}</p></div>)}
                        </div>
                        <div className="form-group"><label>AI Endpoint URL</label><input name="ai_endpoint" value={config.ai_endpoint || ''} onChange={handleChange} /></div>
                        <div className="form-group"><label>AI Model</label><input name="ai_model" value={config.ai_model || ''} onChange={handleChange} /></div>
                        <div className="form-group"><label>AI API Key</label><input type="password" name="ai_api_key" value={config.ai_api_key || ''} onChange={handleChange} /></div>
                        <div className="form-group"><label>Temperature</label><input type="number" step="0.1" name="ai_temperature" value={config.ai_temperature || 0.7} onChange={handleChange} /></div>
                        <div className="form-group"><label>Max Output Tokens</label><input type="number" name="ai_max_output_tokens" value={config.ai_max_output_tokens || 4096} onChange={handleChange} /></div>
                    </div>
                    <button onClick={saveConfig} disabled={loading}>Save All Configurations</button>
                    {status && <span className="status-message">{status}</span>}
                    {error && <p className="error">{error}</p>}
                    <hr style={{margin: '24px 0'}}/>
                    <h3>Actions</h3>
                    <div style={{display: 'flex', alignItems: 'center', gap: '16px', flexWrap: 'wrap'}}>
                        <button onClick={() => runAction('run_ora2pg')} disabled={loading}>Run Ora2Pg from DB</button>
                        <span>OR</span>
                        <div className="form-group" style={{flex: 1, marginBottom: 0}}><input name="localFile" value={localFile} onChange={(e) => setLocalFile(e.target.value)} /></div>
                        <button onClick={() => runAction('load_file')} disabled={loading}>Load & Process Local File</button>
                    </div>
                    {logs && <h4>Logs</h4>}
                    {logs && <div className="logs">{logs}</div>}
                </div>
            );
        }

        function ComparisonView({ client, token, initialSql }) {
            // Full implementation of ComparisonView as it's complex and essential
            const [objects, setObjects] = useState([]);
            const [selectedObject, setSelectedObject] = useState(null);
            const [error, setError] = useState('');
            const [status, setStatus] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const editorRef = useRef(null);
            const correctedEditorRef = useRef(null);

            const loadObjects = async (sqlContent) => {
                setStatus('Parsing SQL objects...');
                try {
                    const response = await axios.post('/api/objects', { sql_content: sqlContent, client_id: client.client_id }, { headers: { Authorization: `Bearer ${token}` } });
                    setObjects(response.data);
                    setStatus('');
                } catch (err) {
                    setError('Failed to parse SQL objects.');
                }
            };
            
            useEffect(() => {
                if (initialSql) {
                    loadObjects(initialSql);
                }
            }, [initialSql, client.client_id, token]);
            
            useEffect(() => {
                if (!editorRef.current) {
                    require.config({ paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.33.0/min/vs' }});
                    require(['vs/editor/editor.main'], () => {
                        editorRef.current = monaco.editor.create(document.getElementById('editor'), { value: '', language: 'sql', readOnly: true });
                        correctedEditorRef.current = monaco.editor.create(document.getElementById('corrected-editor'), { value: '', language: 'sql' });
                    });
                }
                return () => {
                    editorRef.current?.dispose();
                    correctedEditorRef.current?.dispose();
                    editorRef.current = null;
                    correctedEditorRef.current = null;
                };
            }, []);

            useEffect(() => {
                if (selectedObject && editorRef.current && correctedEditorRef.current) {
                    editorRef.current.setValue(selectedObject.sql || '');
                    correctedEditorRef.current.setValue(selectedObject.corrected_sql || selectedObject.sql || '');
                }
            }, [selectedObject]);

            const handleObjectSelect = (obj) => {
                setSelectedObject(obj);
            };
            
            // Placeholder for save and validation logic
            const saveAllCorrections = async () => {
                 // Logic to collect all corrected SQL and send to backend
                 alert("Save all functionality to be implemented.");
            };

            const filteredObjects = objects.filter(obj => obj.name.toLowerCase().includes(searchTerm.toLowerCase()));

            return (
                <div>
                    <div className="form-group">
                        <input type="text" placeholder="Search objects by name..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                    </div>
                    <div style={{ display: 'flex', gap: '16px' }}>
                        <div style={{ flex: '1 1 30%'}}>
                            <h3>SQL Objects</h3>
                            <div className="object-list">
                                {filteredObjects.map(obj => (<div key={obj.name} className="object-item" onClick={() => handleObjectSelect(obj)}>{obj.name} ({obj.type})</div>))}
                            </div>
                        </div>
                        <div style={{ flex: '1 1 70%'}}>
                            <h3>Comparison</h3>
                            {selectedObject ? (
                            <div>
                                <p><strong>Issues:</strong> {selectedObject.issues.join(', ') || 'None detected'}</p>
                                <div className="diff-view">
                                    <div><h4>Original SQL</h4><div id="editor"></div></div>
                                    <div><h4>Corrected SQL</h4><div id="corrected-editor"></div></div>
                                </div>
                                <button>Re-run AI Correction</button>
                                <button>Validate SQL</button>
                            </div>
                            ) : <p>Select an object from the list to view and correct it.</p>}
                        </div>
                    </div>
                    <hr style={{margin: '24px 0'}} />
                    <button onClick={saveAllCorrections}>Save All Corrections to File</button>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

